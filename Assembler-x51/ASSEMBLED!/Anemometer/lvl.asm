;ANALOG LEVEL METER ON HD44780 BASED 16x2 LCD
;14/03/2008
;ASTER


ORG 0000H
SJMP 0030H

ORG 0030H




START: 	MOV 37H,#01H
	MOV 38H,#01H
	MOV 39H,#01H
	MOV 3AH,#02H

	MOV 3BH,#07H
	MOV 3CH,#02H
	MOV 3DH,#01H
	MOV 3EH,#01H
	MOV 3FH,#01H

LCD_BGN:MOV A,#38H
	LCALL COMMAND
	MOV A,#0CH
	LCALL COMMAND
	MOV A,#06H
	LCALL COMMAND
	MOV A,#01H	
	LCALL COMMAND
	
	MOV DPTR,#MSGL

DISP0:	CLR A
	MOVC A,@A+DPTR
	CJNE A,#0FFH,NEXT
	SJMP DONE
NEXT:	LCALL DISPLAY
	INC DPTR
	SJMP DISP0
DONE: 	NOP

AL_MTR:	MOV A,#40H
	MOV R7,A
	LCALL COMMAND
	
	LCALL CG_CLR

	MOV A,#40H
	MOV R7,A
	LCALL COMMAND
	
	LCALL CG_LOAD
	
	MOV A,#0C0H
	LCALL COMMAND
	
	MOV A,#00H
BACK:	LCALL DISPLAY
	INC A
	CJNE A,#08H,BACK
	
	MOV A,#02H
	LCALL COMMAND
	
HERE:	SJMP HERE

;CLEAR CGRAM DATA

CG_CLR:	MOV R6,#40H
RPTC:	MOV A,#00H
	LCALL DISPLAY
	DJNZ R6,RPTC
	RET

;LOAD THE CHARACTER PATTERNS IN CGRAM

CG_LOAD:MOV R3,#00H

DIS_8:	MOV R5,3AH
	CJNE R5,#00H,NXT80
	SJMP OVR0
NXT80:	MOV R6,3CH
NXT801:	MOV R4,3BH
NXT8:	MOV A,#1FH
	INC R3
	LCALL DISPLAY
	DJNZ R4,NXT8
	MOV A,#00H
	INC R3
	LCALL DISPLAY

	DJNZ R6,NXT801
	DJNZ R5,NXT80
OVR0:	NOP


DIS_4:	MOV R5,39H
	CJNE R5,#00H,NXT40
	SJMP OVR1
NXT40:	MOV R6,3DH
NXT401:	MOV R4,3BH
NXT4:	MOV A,#1FH
	INC R3
	LCALL DISPLAY
	DJNZ R4,NXT4
	MOV A,#00H
	INC R3
	LCALL DISPLAY
	DJNZ R6,NXT401
OVR1:	NOP

	
DIS_21:	MOV R5,38H
	CJNE R5,#00H,NXT20
	SJMP DIS_1

NXT20:	MOV R5,37H
	MOV R4,3BH
	CJNE R5,#00H,NXT210
NXT2:	MOV A,#1EH
	INC R3
	LCALL DISPLAY
	DJNZ R4,NXT2
	MOV A,#00H
	INC R3
	LCALL DISPLAY
	SJMP CLRR

NXT210:	MOV A,#1FH
	INC R3
	LCALL DISPLAY
	DJNZ R4,NXT210
	MOV A,#00H
	INC R3
	LCALL DISPLAY
	
	MOV R4,3BH
NXT2101:MOV A,#10H
	INC R3
	LCALL DISPLAY
	DJNZ R4,NXT2101
	MOV A,#00H
	INC R3	
	LCALL DISPLAY
	SJMP CLRR	


DIS_1:	MOV R4,3BH
	MOV R5,37H
	CJNE R5,#00H,REP1
	SJMP CLRR
REP1:	MOV A,#18H
	INC R3
	LCALL DISPLAY
	DJNZ R4,REP1
	MOV A,#00H
	INC R3
	LCALL DISPLAY

CLRR:	MOV A,#00H
	CJNE R3,#40H,REPR
	SJMP OVER
REPR:	JNC OVER
	INC R3
	LCALL DISPLAY
	SJMP CLRR

OVER:	NOP
	RET

;------------------------------------------------------------------------------------------------------
;LCD FUNCTIONS

COMMAND:	LCALL READY
		CLR P1.2
		CLR P1.1
		MOV P2,A
		SETB P1.3
		NOP 
		CLR P1.3
		RET

DISPLAY:	LCALL READY
		CLR P1.2
		SETB P1.1
		MOV P2,A
		SETB P1.3
		NOP
		CLR P1.3
		RET


READY:		SETB P2.7
		CLR P1.1
		SETB P1.2
BUSY:		CLR P1.3
		SETB P1.3
		JB P2.7,BUSY
		NOP
		CLR P1.3
		RET

;--------------------------------------------------------------------------------------------------------
;DISPLAY RECORD
	
	MSGL: DB 'Analog meter'

END












































	